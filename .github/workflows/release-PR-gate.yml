name: PR Gate ‚Äî head commit must be a release tag

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - "releases-preprod"
      - "releases-beta"
      - "releases-prod"
      - "release-gate"

jobs:
  require_tagged_head:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # V√©rifie si le HEAD de la PR est exactement tagu√© vX.Y.Z (sans √©chouer le job ici)
      - name: Check PR head has exact vX.Y.Z tag
        id: check
        shell: bash
        run: |
          set -euo pipefail
          SHA="${{ github.event.pull_request.head.sha }}"
          BASE="${{ github.event.pull_request.base.ref }}"   # ex: releases-preprod
          HEADBR="${{ github.event.pull_request.head.ref }}" # ex: release/6.2

          git fetch --tags --force

          TAG="$(git tag --points-at "$SHA" --list 'v[0-9]*.[0-9]*.[0-9]*' | head -n1 || true)"

          if [ -n "$TAG" ]; then
            echo "ok=true"  >> "$GITHUB_OUTPUT"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "PR head is exactly tag $TAG"
            exit 0
          fi

          read -r -d '' HELP <<'EOF'
          ‚ùå Cette PR ne pointe pas sur un commit de release (tag `vX.Y.Z`).
          
          Ce qu‚Äôil faut faire :
          1) **Cr√©er une release tagu√©e** sur la branche `release/X.Y` concern√©e
             (ex.: merger sur `release/6.2` pour d√©clencher la CI qui cr√©e `v6.2.Z`),
             ou cr√©er le tag `vX.Y.Z` sur le commit voulu.
          2) **Faire pointer la PR exactement sur ce commit tagu√©** :
             - en mettant √† jour la branche source de la PR pour qu‚Äôelle pointe sur le tag :
               `git reset --hard vX.Y.Z && git push -f`
             - ou en recr√©ant la PR depuis le commit tagu√©.
          
          üí° Raison : les d√©ploiements `releases-preprod/beta/prod` n‚Äôacceptent que des commits **exactement tagu√©s**.
          EOF

          # encode en base64 pour le passer proprement
          HELP_B64="$(printf '%s' "$HELP" | base64 -w0)"
          echo "ok=false"            >> "$GITHUB_OUTPUT"
          echo "help_b64=$HELP_B64"  >> "$GITHUB_OUTPUT"

      - name: Comment PR
        if: ${{ steps.check.outputs.ok != 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const number = context.payload.pull_request.number;
            const base = context.payload.pull_request.base.ref;
            const head = context.payload.pull_request.head.ref;
            const help = decodeURIComponent(`${{ steps.check.outputs.help }}`);
            const body = `### Gate: commit non tagu√© pour **${base}**\n\n` +
                         `Branche source: \`${head}\`\n\n` + help;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body
            });

      - name: Fail if not OK
        if: ${{ steps.check.outputs.ok != 'true' }}
        run: |
          echo "Blocking: PR head is not exactly a vX.Y.Z tag."
          exit 1