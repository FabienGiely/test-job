name: Check version drift (preprod vs prod)

on:
  pull_request:
    branches: [release-prod]
    types: [opened, synchronize, reopened, edited]
  workflow_dispatch:

jobs:
  version-drift:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    env:
      PREPROD_PATH: preprod.json    # adapte si besoin (ex: env/preprod.json)
      PROD_PATH: prod.json          # adapte si besoin (ex: env/prod.json)
      # Optionnel: ignorer certains services (s√©par√©s par |). Exemple: "sesha-kpi|sesha-puppeteer-api"
      IGNORE_REGEX: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compare preprod.json vs prod.json
        id: compare
        shell: bash
        run: |
          set -Eeuo pipefail

          PREPROD="$PREPROD_PATH"
          PROD="$PROD_PATH"

          # V√©rif fichiers
          if [[ ! -f "$PREPROD" || ! -f "$PROD" ]]; then
            SUMMARY=$'### üîé Comparaison des versions (preprod vs prod)\n:warning: Fichiers introuvables: `'"$PREPROD"'` ou `'"$PROD"'`.'
            HAS_DIFFS=1
          else
            TMPDIR="$(mktemp -d)"
            trap 'rm -rf "$TMPDIR"' EXIT

            # Extrait les noms; applique √©ventuellement un filtre d'ignor√©s
            jq -r '.[].name' "$PREPROD" | sort -u > "$TMPDIR/preprod.names"
            jq -r '.[].name' "$PROD"     | sort -u > "$TMPDIR/prod.names"

            if [[ -n "${IGNORE_REGEX}" ]]; then
              grep -Ev "$IGNORE_REGEX" "$TMPDIR/preprod.names" > "$TMPDIR/preprod.filtered" || true
              grep -Ev "$IGNORE_REGEX" "$TMPDIR/prod.names"    > "$TMPDIR/prod.filtered"    || true
            else
              cp "$TMPDIR/preprod.names" "$TMPDIR/preprod.filtered"
              cp "$TMPDIR/prod.names"    "$TMPDIR/prod.filtered"
            fi

            # Sets utiles
            MISSING_IN_PROD=$(comm -23 "$TMPDIR/preprod.filtered" "$TMPDIR/prod.filtered" || true)
            MISSING_IN_PREPROD=$(comm -13 "$TMPDIR/preprod.filtered" "$TMPDIR/prod.filtered" || true)
            COMMON=$(comm -12 "$TMPDIR/preprod.filtered" "$TMPDIR/prod.filtered" || true)

            # Versions diff√©rentes sur les services communs
            DIFFS=""
            while IFS= read -r SVC; do
              [[ -z "${SVC:-}" ]] && continue
              VP=$(jq -r --arg n "$SVC" '.[] | select(.name==$n) | .version' "$PREPROD")
              VR=$(jq -r --arg n "$SVC" '.[] | select(.name==$n) | .version' "$PROD")
              if [[ "$VP" != "$VR" ]]; then
                DIFFS+="- \`$SVC\`: preprod=\`$VP\` vs prod=\`$VR\`\n"
              fi
            done <<< "$COMMON"

            # Construit le r√©sum√©
            HAS_DIFFS=0
            SUMMARY="### üîé Comparaison des versions (preprod vs prod)\n"

            if [[ -n "$MISSING_IN_PROD" ]]; then
              HAS_DIFFS=1
              SUMMARY+="\n**Manquants dans prod**:\n"
              while IFS= read -r SVC; do
                [[ -n "${SVC:-}" ]] && SUMMARY+="- \`$SVC\`\n"
              done <<< "$MISSING_IN_PROD"
            fi

            if [[ -n "$MISSING_IN_PREPROD" ]]; then
              HAS_DIFFS=1
              SUMMARY+="\n**Manquants dans preprod**:\n"
              while IFS= read -r SVC; do
                [[ -n "${SVC:-}" ]] && SUMMARY+="- \`$SVC\`\n"
              done <<< "$MISSING_IN_PREPROD"
            fi

            if [[ -n "$DIFFS" ]]; then
              HAS_DIFFS=1
              SUMMARY+="\n**Versions diff√©rentes**:\n$DIFFS"
            fi

            if [[ $HAS_DIFFS -eq 0 ]]; then
              SUMMARY+="\n‚úÖ Aucune diff√©rence d√©tect√©e."
            fi
          fi

          # R√©sum√© dans l‚Äôonglet "Summary" du job
          printf "%b" "$SUMMARY" >> "$GITHUB_STEP_SUMMARY"

          # Expose aux steps suivantes (base64 1-ligne pour √©viter les soucis d'encodage)
          echo "has_diffs=$HAS_DIFFS" >> "$GITHUB_OUTPUT"
          SUMMARY_B64=$(printf "%s" "$SUMMARY" | base64 -w0)
          echo "summary_b64=$SUMMARY_B64" >> "$GITHUB_OUTPUT"

          # Echoue la step (et donc le job) s‚Äôil y a des √©carts
          if [[ $HAS_DIFFS -ne 0 ]]; then
            exit 1
          fi

      - name: Comment PR with results
        if: always() && github.event.pull_request.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const b64 = process.env.SUMMARY_B64 || '';
            const body = Buffer.from(b64, 'base64').toString('utf8') || 'Comparaison effectu√©e.';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
        env:
          SUMMARY_B64: ${{ steps.compare.outputs.summary_b64 }}
