name: Check version drift (preprod vs prod)

on:
  pull_request:
    branches: [release-prod]
    types: [opened, synchronize, reopened, edited]
  workflow_dispatch:

jobs:
  version-drift:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    env:
      PREPROD_PATH: preprod.json     # ex: env/preprod.json
      PROD_PATH: prod.json           # ex: env/prod.json
      IGNORE_REGEX: ""               # ex: "sesha-kpi|sesha-puppeteer-api"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compare preprod.json vs prod.json
        id: compare
        shell: bash
        run: |
          set -Eeuo pipefail

          PREPROD="$PREPROD_PATH"
          PROD="$PROD_PATH"

          HAS_DIFFS=0
          SUMMARY=$'### üîé Comparaison des versions (preprod vs prod)\n'

          if [[ ! -f "$PREPROD" || ! -f "$PROD" ]]; then
            SUMMARY+=$':warning: Fichiers introuvables: `'"$PREPROD"$'` ou `'"$PROD"$'`.\n'
            HAS_DIFFS=1
          else
            TMPDIR="$(mktemp -d)"
            trap 'rm -rf "$TMPDIR"' EXIT

            # Noms des services
            jq -r '.[].name' "$PREPROD" | sort -u > "$TMPDIR/preprod.names"
            jq -r '.[].name' "$PROD"     | sort -u > "$TMPDIR/prod.names"

            # Applique √©ventuellement un filtre d'exclusion
            if [[ -n "${IGNORE_REGEX}" ]]; then
              grep -Ev "$IGNORE_REGEX" "$TMPDIR/preprod.names" > "$TMPDIR/preprod.filtered" || true
              grep -Ev "$IGNORE_REGEX" "$TMPDIR/prod.names"    > "$TMPDIR/prod.filtered"   || true
            else
              cp "$TMPDIR/preprod.names" "$TMPDIR/preprod.filtered"
              cp "$TMPDIR/prod.names"    "$TMPDIR/prod.filtered"
            fi

            # Diff√©rences d'ensemble
            MISSING_IN_PROD=$(comm -23 "$TMPDIR/preprod.filtered" "$TMPDIR/prod.filtered" || true)
            MISSING_IN_PREPROD=$(comm -13 "$TMPDIR/preprod.filtered" "$TMPDIR/prod.filtered" || true)
            COMMON=$(comm -12 "$TMPDIR/preprod.filtered" "$TMPDIR/prod.filtered" || true)

            if [[ -n "$MISSING_IN_PROD" ]]; then
              HAS_DIFFS=1
              SUMMARY+=$'\n**Manquants dans prod**:\n'
              while IFS= read -r SVC; do
                [[ -z "${SVC:-}" ]] && continue
                printf -v SUMMARY '%s- `%s`\n' "$SUMMARY" "$SVC"
              done <<< "$MISSING_IN_PROD"
            fi

            if [[ -n "$MISSING_IN_PREPROD" ]]; then
              HAS_DIFFS=1
              SUMMARY+=$'\n**Manquants dans preprod**:\n'
              while IFS= read -r SVC; do
                [[ -z "${SVC:-}" ]] && continue
                printf -v SUMMARY '%s- `%s`\n' "$SUMMARY" "$SVC"
              done <<< "$MISSING_IN_PREPROD"
            fi

            # Versions diff√©rentes sur les services communs
            DIFFS=""
            while IFS= read -r SVC; do
              [[ -z "${SVC:-}" ]] && continue
              VP=$(jq -r --arg n "$SVC" '.[] | select(.name==$n) | .version' "$PREPROD")
              VR=$(jq -r --arg n "$SVC" '.[] | select(.name==$n) | .version' "$PROD")
              if [[ "$VP" != "$VR" ]]; then
                printf -v DIFFS '%s- `%s`: preprod=`%s` vs prod=`%s`\n' "$DIFFS" "$SVC" "$VP" "$VR"
              fi
            done <<< "$COMMON"

            if [[ -n "$DIFFS" ]]; then
              HAS_DIFFS=1
              SUMMARY+=$'\n**Versions diff√©rentes**:\n'
              SUMMARY+="$DIFFS"
            fi

            if [[ $HAS_DIFFS -eq 0 ]]; then
              SUMMARY+=$'\n‚úÖ Aucune diff√©rence d√©tect√©e.\n'
            fi
          fi

          # R√©sum√© visible dans l'onglet "Summary" du job
          printf '%s' "$SUMMARY" >> "$GITHUB_STEP_SUMMARY"

          # Outputs pour la step suivante (base64 une ligne = safe)
          echo "has_diffs=$HAS_DIFFS" >> "$GITHUB_OUTPUT"
          if SUMMARY_B64=$(printf '%s' "$SUMMARY" | base64 -w0 2>/dev/null); then
            :
          else
            SUMMARY_B64=$(printf '%s' "$SUMMARY" | base64 | tr -d '\n')
          fi
          echo "summary_b64=$SUMMARY_B64" >> "$GITHUB_OUTPUT"

          # √âchoue le job s'il y a des √©carts (check rouge). La step suivante tourne quand m√™me (if: always()).
          if [[ $HAS_DIFFS -ne 0 ]]; then
            exit 1
          fi

      - name: Comment PR with results
        if: always() && github.event.pull_request.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const b64 = process.env.SUMMARY_B64 || '';
            const body = Buffer.from(b64, 'base64').toString('utf8') || 'Comparaison effectu√©e.';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
        env:
          SUMMARY_B64: ${{ steps.compare.outputs.summary_b64 }}
